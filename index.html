<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Capital Restructuring System V3.7 (CN-Mobile)</title>
    
    <!-- ğŸŸ¢ æ ¸å¿ƒæ ·å¼ï¼šä½¿ç”¨å›½å†… Staticfile æºçš„ Tailwind CSS V2 (100% å›½å†…å¯è®¿é—®) -->
    <link href="https://cdn.staticfile.net/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    
    <!-- ğŸŸ¢ æ ¸å¿ƒå¼•æ“ï¼šä½¿ç”¨å›½å†… Staticfile æºçš„ React -->
    <script crossorigin src="https://cdn.staticfile.net/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.staticfile.net/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.staticfile.net/babel-standalone/7.23.5/babel.min.js"></script>
    
    <style>
        body { background-color: #111827; overscroll-behavior-y: none; }
        /* iOS ä¼˜åŒ– */
        body { -webkit-tap-highlight-color: transparent; }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* è¡¥å…… Tailwind V2 ç¼ºå¤±çš„è‡ªå®šä¹‰æ ·å¼ */
        .text-xxs { font-size: 10px; line-height: 14px; }
        .bg-gray-900-50 { background-color: rgba(17, 24, 39, 0.5); }
        .bg-green-900-20 { background-color: rgba(6, 78, 59, 0.2); }
        .bg-red-900-20 { background-color: rgba(127, 29, 29, 0.2); }
        .bg-red-900-50 { background-color: rgba(127, 29, 29, 0.5); }
        .bg-red-900-30 { background-color: rgba(127, 29, 29, 0.3); }
        .bg-blue-900-50 { background-color: rgba(30, 58, 138, 0.5); }
        .bg-yellow-900-20 { background-color: rgba(113, 63, 18, 0.2); }
        .bg-orange-900-30 { background-color: rgba(124, 45, 18, 0.3); }
        .bg-gray-800-50 { background-color: rgba(31, 41, 55, 0.5); }
        
        .border-blue-500-50 { border-color: rgba(59, 130, 246, 0.5); }
        .border-purple-500-50 { border-color: rgba(168, 85, 247, 0.5); }
        .border-yellow-500-50 { border-color: rgba(234, 179, 8, 0.5); }
        .border-orange-500-50 { border-color: rgba(249, 115, 22, 0.5); }
        .border-yellow-700-50 { border-color: rgba(161, 98, 7, 0.5); }

        .timeline-line::before {
            content: '';
            position: absolute;
            left: 7px;
            top: 24px;
            bottom: -16px;
            width: 2px;
            background: #374151;
            z-index: 0;
        }
        .timeline-item:last-child .timeline-line::before {
            display: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Icons (ä¿æŒä¸å˜) ---
        const Icon = ({ path, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Activity: (p) => <Icon {...p} path={<polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />} />,
            TrendingUp: (p) => <Icon {...p} path={<g><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></g>} />,
            TrendingDown: (p) => <Icon {...p} path={<g><polyline points="23 18 13.5 8.5 8.5 13.5 1 6" /><polyline points="17 18 23 18 23 12" /></g>} />,
            ShieldAlert: (p) => <Icon {...p} path={<g><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></g>} />,
            Coffee: (p) => <Icon {...p} path={<g><path d="M18 8h1a4 4 0 0 1 0 8h-1" /><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z" /><line x1="6" y1="1" x2="6" y2="4" /><line x1="10" y1="1" x2="10" y2="4" /><line x1="14" y1="1" x2="14" y2="4" /></g>} />,
            Cigarette: (p) => <Icon {...p} path={<g><path d="M2 12h20" /><path d="M22 12v0" /><path d="M18 12v0" /><path d="M2 12v0" /><path d="M18 8v8" /><path d="M22 8v8" /><path d="M2 8v8" /></g>} />, 
            PlayCircle: (p) => <Icon {...p} path={<g><circle cx="12" cy="12" r="10" /><polygon points="10 8 16 12 10 16 10 8" /></g>} />,
            Ban: (p) => <Icon {...p} path={<g><circle cx="12" cy="12" r="10" /><line x1="4.93" y1="4.93" x2="19.07" y2="19.07" /></g>} />,
            CheckCircle2: (p) => <Icon {...p} path={<g><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" /><path d="m9 12 2 2 4-4" /></g>} />,
            Zap: (p) => <Icon {...p} path={<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />} />,
            RotateCcw: (p) => <Icon {...p} path={<g><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></g>} />,
            ShoppingBag: (p) => <Icon {...p} path={<g><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z" /><path d="M3 6h18" /><path d="M16 10a4 4 0 0 1-8 0" /></g>} />,
            BookOpen: (p) => <Icon {...p} path={<g><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" /><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" /></g>} />,
            PenTool: (p) => <Icon {...p} path={<g><path d="m12 19 7-7 3 3-7 7-3-3z" /><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z" /><path d="m2 2 7.586 7.586" /><circle cx="11" cy="11" r="2" /></g>} />,
            Save: (p) => <Icon {...p} path={<g><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></g>} />,
            Clock: (p) => <Icon {...p} path={<g><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></g>} />,
            Flame: (p) => <Icon {...p} path={<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z" />} />,
            AlertTriangle: (p) => <Icon {...p} path={<g><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></g>} />,
        };

        const PHASES = [
            { id: 1, name: "ç¬¬ä¸€é˜¶æ®µï¼šè„±æ•è®­ç»ƒ", days: [1, 2, 3], desc: "æ–°æ‰‹ä¿æŠ¤æœŸã€‚ç›®æ ‡ä¸æ˜¯æˆ’çƒŸï¼Œè€Œæ˜¯æ‰“ç ´'è‡ªåŠ¨å¸çƒŸ'çš„ä¹ æƒ¯ã€‚", limit: 10, color: "text-blue-400", borderColor: "border-blue-500-50" },
            { id: 2, name: "ç¬¬äºŒé˜¶æ®µï¼šå‡é‡æ§ç›˜", days: [4, 5, 6, 7], desc: "è¿›é˜¶æŒ‘æˆ˜ã€‚ç›®æ ‡æ˜¯æ§åˆ¶é¥­åç­‰å…³é”®èŠ‚ç‚¹çš„æ¬²æœ›ï¼Œæ€»é‡å‡åŠã€‚", limit: 5, color: "text-purple-400", borderColor: "border-purple-500-50" },
            { id: 3, name: "ç¬¬ä¸‰é˜¶æ®µï¼šæ¸…é›¶å†³æˆ˜", days: [8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21], desc: "å¤§å¸ˆæ¨¡å¼ã€‚å½»åº•æ¸…é™¤å°¼å¤ä¸æ®‹ç•™ï¼Œé‡å¡‘å¤šå·´èƒºå›è·¯ã€‚", limit: 0, color: "text-yellow-400", borderColor: "border-yellow-500-50" }
        ];

        const REWARDS_DATA = [
            { id: 'game', label: 'æ¸¸æˆ/å¨±ä¹ 1å°æ—¶', cost: 200, icon: <Icons.PlayCircle size={18} /> },
            { id: 'cola', label: 'æ— ç³–å¯ä¹/é›¶é£Ÿ', cost: 150, icon: <Icons.Coffee size={18} /> },
            { id: 'cheat_meal', label: 'æ¬ºéª—é¤ (ç«é”…/çƒ¤è‚‰)', cost: 1500, icon: <Icons.ShoppingBag size={18} /> },
            { id: 'gear', label: 'è´­ä¹°å¥èº«/æ•°ç è£…å¤‡', cost: 3000, icon: <Icons.Activity size={18} /> },
        ];

        const LEVELS = [
            { name: 'LV.0 æ•£æˆ·', min: -99999, color: 'text-gray-500' },
            { name: 'LV.1 è§‰é†’è€…', min: 0, color: 'text-blue-400' },
            { name: 'LV.2 æ¸¸èµ„', min: 1000, color: 'text-purple-400' },
            { name: 'LV.3 ä¸»åŠ›', min: 3000, color: 'text-yellow-400' },
            { name: 'LV.4 åº„å®¶', min: 5000, color: 'text-green-400' },
        ];

        function CapitalRestructuringApp() {
            const [points, setPoints] = useState(0);
            const [day, setDay] = useState(1);
            const [smokeCount, setSmokeCount] = useState(0);
            const [completedTasks, setCompletedTasks] = useState({}); 
            const [logs, setLogs] = useState([]); 
            const [journals, setJournals] = useState([]);
            const [smokingLogs, setSmokingLogs] = useState([]);
            const [journalInput, setJournalInput] = useState("");
            const [activeTab, setActiveTab] = useState('dashboard'); 

            useEffect(() => {
                let savedData = localStorage.getItem('capital_system_v3_4_html');
                
                if (!savedData) {
                    savedData = localStorage.getItem('capital_system_v3_3_html') || localStorage.getItem('capital_system_v3_2_html');
                }

                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        setPoints(Number(parsed.points) || 0);
                        setDay((Number(parsed.day) || 1) > 21 ? 21 : (Number(parsed.day) || 1));
                        setSmokeCount(Number(parsed.smokeCount) || 0);
                        setCompletedTasks(parsed.completedTasks || {});
                        setLogs(parsed.logs || []);
                        setJournals(parsed.journals || []);
                        setSmokingLogs(parsed.smokingLogs || []);

                    } catch (e) {
                        console.error("å­˜æ¡£æŸåï¼Œé‡ç½®ç³»ç»Ÿ", e);
                        addLog('å­˜æ¡£æŸåï¼Œå·²é‡ç½®ç³»ç»Ÿ', 0, 'system');
                    }
                } else {
                    addLog('ç³»ç»Ÿåˆå§‹åŒ– (CN Line)', 0, 'system');
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('capital_system_v3_4_html', JSON.stringify({
                    points, day, smokeCount, completedTasks, logs, journals, smokingLogs
                }));
            }, [points, day, smokeCount, completedTasks, logs, journals, smokingLogs]);

            const getDayKey = () => `day_${day}`;
            const getCurrentPhase = () => PHASES.find(p => p.days.includes(day)) || PHASES[PHASES.length - 1];
            const getCurrentLevel = () => LEVELS.slice().reverse().find(l => points >= l.min) || LEVELS[0];

            const addLog = (desc, amount, type) => {
                const newLog = {
                    id: Date.now(), desc, amount, type, 
                    time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
                };
                setLogs(prev => [newLog, ...prev].slice(0, 50));
            };

            const getTasksForCurrentPhase = () => {
                const phase = getCurrentPhase();
                const tasks = [];
                tasks.push({ id: 'morning_read', label: 'æ—©ç›˜ï¼šé˜…è¯»ç ”æŠ¥/ä¹¦ç± (15min)', points: 50, category: 'æ—©ç›˜æ“ä½œ' });
                tasks.push({ id: 'mid_contract', label: 'ç›˜ä¸­ï¼šæœªæ‰“å¼€å®ç›˜åˆçº¦è½¯ä»¶', points: 50, category: 'ç›˜ä¸­é£æ§' });
                if (phase.id === 1) {
                    tasks.push({ id: 'morning_delay', label: 'æ—©ç›˜ï¼šé†’æ¥30åˆ†é’Ÿå†…æœªå¸çƒŸ', points: 50, category: 'æ—©ç›˜æ“ä½œ' });
                    tasks.push({ id: 'mid_game_smoke', label: 'ç›˜ä¸­ï¼šç©æ¸¸æˆ/çœ‹ç›˜æ—¶æ‰‹è¾¹æ— çƒŸ', points: 30, category: 'ç›˜ä¸­é£æ§' });
                }
                if (phase.id === 2) {
                    tasks.push({ id: 'morning_delay_60', label: 'æ—©ç›˜ï¼šé†’æ¥60åˆ†é’Ÿå†…æœªå¸çƒŸ', points: 60, category: 'æ—©ç›˜æ“ä½œ' });
                    tasks.push({ id: 'mid_after_meal', label: 'ç›˜ä¸­ï¼šåˆ/æ™šé¥­å1å°æ—¶æœªå¸çƒŸ', points: 60, category: 'ç›˜ä¸­é£æ§' });
                }
                if (phase.id === 3) {
                    tasks.push({ id: 'all_day_zero', label: 'å…¨å¤©ï¼šä¸€æ ¹æœªæŠ½ (é‡‘èº«)', points: 200, category: 'å†³æˆ˜æ—¶åˆ»' });
                }
                return tasks;
            };

            const handleTaskToggle = (task) => {
                const key = `${getDayKey()}_${task.id}`;
                if (completedTasks[key]) return; 
                setCompletedTasks(prev => ({ ...prev, [key]: true }));
                setPoints(prev => prev + task.points);
                addLog(`å…¥è´¦: ${task.label}`, task.points, 'income');
            };

            const handleJournalSubmit = () => {
                if (!journalInput.trim()) {
                    alert("è¯·è‡³å°‘å†™ä¸€ä¸ªå­—ã€‚");
                    return;
                }
                const newEntry = {
                    day: day, date: new Date().toLocaleDateString('zh-CN'),
                    content: journalInput, timestamp: new Date().toLocaleTimeString('zh-CN')
                };
                setJournals(prev => [newEntry, ...prev]);
                setJournalInput("");
                const taskKey = `${getDayKey()}_end_journal`;
                if (!completedTasks[taskKey]) {
                    setCompletedTasks(prev => ({ ...prev, [taskKey]: true }));
                    setPoints(prev => prev + 30);
                    addLog(`ä»»åŠ¡å®Œæˆ: æƒ…ç»ªæ—¥å¿—å­˜æ¡£`, 30, 'income');
                }
                alert("æ—¥å¿—å·²å­˜æ¡£ï¼");
            };

            const handleSmokeIncrement = () => {
                const reason = window.prompt("ã€äº¤æ˜“å½•å•ã€‘\nè¯·å½•å…¥æœ¬æ¬¡å¸çƒŸï¼ˆå¼€ä»“ï¼‰è¯±å› ï¼š\n(ä¾‹å¦‚ï¼šé¥­åã€ç„¦è™‘ã€æ— èŠã€è·Ÿé£ã€èµ·åºŠ)");
                if (reason === null) return;

                const now = new Date();
                const timestamp = now.getTime();
                const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                
                const todayLogs = smokingLogs.filter(l => l.day === day);
                const lastSmoke = todayLogs.length > 0 ? todayLogs[0] : null;

                let intervalStr = "é¦–å•";
                let intervalMinutes = 0;
                
                if (lastSmoke) {
                    const diffMs = timestamp - lastSmoke.timestamp;
                    intervalMinutes = Math.floor(diffMs / 60000);
                    const hours = Math.floor(intervalMinutes / 60);
                    const mins = intervalMinutes % 60;
                    intervalStr = `+${hours > 0 ? hours + 'h' : ''}${mins}m`;
                }

                const newSmokeLog = {
                    id: timestamp,
                    day: day,
                    time: timeStr,
                    timestamp: timestamp,
                    reason: reason || "æ— ç†ç”±æ³¢åŠ¨", // é»˜è®¤å€¼
                    interval: intervalStr,
                    intervalRaw: intervalMinutes
                };

                setSmokeCount(prev => prev + 1);
                setSmokingLogs(prev => [newSmokeLog, ...prev]);
            };

            const handlePunishment = (type) => {
                let penalty = 0;
                let desc = '';
                if (type === 'porn') { penalty = -200; desc = 'ç†”æ–­: æµè§ˆè‰²æƒ…/æ‰‹æ·«'; }
                if (type === 'contract') { penalty = -500; desc = 'ç†”æ–­: å¼€åˆçº¦å•'; }
                if (window.confirm(`ç¡®è®¤è§¦å‘ç†”æ–­æœºåˆ¶ï¼Ÿè¿™å°†äºæŸ Â¥${Math.abs(penalty)}`)) {
                    setPoints(prev => prev + penalty);
                    addLog(desc, penalty, 'punishment');
                }
            };

            const handleRedeem = (reward) => {
                if (points >= reward.cost) {
                    if (window.confirm(`ç¡®è®¤æ¶ˆè´¹ Â¥${reward.cost} å…‘æ¢ ${reward.label}?`)) {
                        setPoints(prev => prev - reward.cost);
                        addLog(`æ¶ˆè´¹: ${reward.label}`, -reward.cost, 'expense');
                    }
                } else {
                    alert('å¯ç”¨èµ„é‡‘ä¸è¶³');
                }
            };

            const nextDay = () => {
                const phase = getCurrentPhase();
                const limit = phase.limit;
                let dailySummary = `Day ${day} ç»“ç®—`;
                let dailyPoints = 0;

                if (smokeCount <= limit) {
                    dailyPoints += 100; 
                    dailySummary += `: æ§çƒŸæˆåŠŸ (${smokeCount}/${limit})`;
                } else {
                    const over = smokeCount - limit;
                    const penalty = over * 50; 
                    dailyPoints -= penalty;
                    dailySummary += `: æ§çƒŸå¤±è´¥ (è¶…${over}æ ¹, æ‰£${penalty})`;
                }

                if (window.confirm(`${dailySummary}\nç¡®è®¤ç»“æŸä»Šæ—¥äº¤æ˜“ï¼Œå¼€å§‹æ–°çš„ä¸€å¤©ï¼Ÿ`)) {
                    setPoints(prev => prev + dailyPoints);
                    addLog(dailySummary, dailyPoints, dailyPoints >= 0 ? 'income' : 'punishment');
                    
                    setDay(prev => Number(prev) + 1); 
                    setSmokeCount(0); 
                    setJournalInput("");
                    addLog(`è¿›å…¥ç¬¬ ${Number(day) + 1} å¤©`, 0, 'system');
                    
                    setTimeout(() => {
                        const rootDiv = document.querySelector('.overflow-y-auto');
                        if (rootDiv) rootDiv.scrollTop = 0;
                    }, 100);
                }
            };

            const resetSystem = () => {
                if (window.confirm('è­¦å‘Šï¼šç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†æ¸…ç©ºä½ çš„æ‰€æœ‰èµ„äº§ã€‚')) {
                    setPoints(0); setDay(1); setSmokeCount(0);
                    setCompletedTasks({}); setLogs([]); setJournals([]); setSmokingLogs([]);
                    localStorage.removeItem('capital_system_v3_4_html');
                }
            };

            // æ‰‹åŠ¨å…¼å®¹ V2 çš„æ ·å¼é€»è¾‘
            const getCounterStyle = () => {
                const limit = currentPhase.limit;
                if (limit === 0) return smokeCount === 0 ? 'bg-green-900-20 border-green-800' : 'bg-red-900 border-red-600 animate-pulse';
                const ratio = smokeCount / limit;
                if (ratio < 0.5) return 'bg-gray-800 border-gray-700'; 
                if (ratio < 0.8) return 'bg-yellow-900-20 border-yellow-800'; 
                if (ratio <= 1.0) return 'bg-orange-900-30 border-orange-700'; 
                return 'bg-red-900-50 border-red-600'; 
            };

            const getCounterTextColor = () => {
                const limit = currentPhase.limit;
                if (limit === 0) return smokeCount > 0 ? 'text-red-500' : 'text-green-500';
                const ratio = smokeCount / limit;
                if (ratio < 0.5) return 'text-blue-400';
                if (ratio < 0.8) return 'text-yellow-400';
                if (ratio <= 1.0) return 'text-orange-500';
                return 'text-red-500';
            };

            const currentLevel = getCurrentLevel();
            const currentPhase = getCurrentPhase();
            const currentTasks = getTasksForCurrentPhase();
            const isJournalDoneToday = completedTasks[`${getDayKey()}_end_journal`];
            const todaySmokingLogs = smokingLogs.filter(l => l.day === day);
            
            const groupedTasks = currentTasks.reduce((acc, task) => {
                if (!acc[task.category]) acc[task.category] = [];
                acc[task.category].push(task);
                return acc;
            }, {});

            return (
                <div className="min-h-screen bg-gray-900 text-gray-100 font-sans max-w-md mx-auto shadow-2xl overflow-hidden flex flex-col">
                    <div className="bg-gray-800 p-4 border-b border-gray-700 sticky top-0 z-10">
                        <div className="flex justify-between items-center mb-2">
                            <div className="flex items-center space-x-2">
                                <Icons.Activity className="text-green-500" size={20} />
                                <h1 className="font-bold text-lg tracking-wider">CAPITAL RESTRUCTURING</h1>
                            </div>
                            <div className={`text-xs px-2 py-1 rounded border ${currentPhase.borderColor} ${currentPhase.color} bg-gray-900`}>
                                Day {day} / 21
                            </div>
                        </div>
                        <div className="flex justify-between items-end mt-4">
                            <div>
                                <div className="text-sm text-gray-400">æ€»èµ„äº§ (CNY)</div>
                                <div className={`text-3xl font-mono font-bold ${points < 0 ? 'text-red-500' : 'text-green-500'}`}>
                                    Â¥ {points.toLocaleString()}
                                </div>
                            </div>
                            <div className={`text-sm font-bold ${currentLevel.color}`}>{currentLevel.name}</div>
                        </div>
                        <div className={`mt-4 p-2 rounded bg-gray-900-50 border ${currentPhase.borderColor}`}>
                            <div className={`text-xs font-bold ${currentPhase.color} mb-1`}>å½“å‰å‘¨æœŸï¼š{currentPhase.name}</div>
                            <div className="text-xxs text-gray-400">{currentPhase.desc}</div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-6">
                        {activeTab === 'dashboard' && (
                            <>
                                <div className="bg-gray-800 p-4 rounded-xl border border-blue-900-50">
                                    <div className="flex items-center justify-between mb-2">
                                        <div className="flex items-center space-x-2 text-blue-400">
                                            <Icons.PenTool size={18} />
                                            <h2 className="font-bold text-sm">é—ªç”µäº¤æ˜“æ—¥å¿—</h2>
                                        </div>
                                        {isJournalDoneToday && <Icons.CheckCircle2 size={16} className="text-green-500" />}
                                    </div>
                                    <div className="flex space-x-2">
                                        <textarea 
                                            value={journalInput}
                                            onChange={(e) => setJournalInput(e.target.value)}
                                            placeholder="æ­¤åˆ»æ„Ÿå—ï¼šç„¦è™‘ï¼Ÿå¹³é™ï¼Ÿæƒ³å¼€å•ï¼Ÿå†™ä¸‹æ¥..."
                                            className="flex-1 h-12 bg-gray-900 border border-gray-700 rounded p-2 text-xs text-gray-200 focus:outline-none focus:border-blue-500 resize-none"
                                        />
                                        <button onClick={handleJournalSubmit} className="w-16 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded flex flex-col items-center justify-center">
                                            <Icons.Save size={14} className="mb-1" /> å­˜æ¡£
                                        </button>
                                    </div>
                                </div>

                                <div className={`p-4 rounded-xl border transition-colors duration-500 ${getCounterStyle()}`}>
                                    <div className="flex justify-between items-center mb-3">
                                        <div className="flex items-center space-x-2">
                                            <Icons.Flame className={getCounterTextColor()} size={20} />
                                            <span className="font-bold text-sm text-gray-300">å¸çƒŸè®¡æ•°å™¨</span>
                                        </div>
                                        <div className="text-xs text-gray-400">æ­¢æŸçº¿: <span className="font-mono font-bold">{currentPhase.limit}</span></div>
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <div className="flex flex-col">
                                            <span className={`text-5xl font-mono font-bold transition-colors duration-300 ${getCounterTextColor()}`}>{smokeCount}</span>
                                            <span className="text-xxs text-gray-400 mt-1">{smokeCount > currentPhase.limit ? 'å·²çˆ†ä»“ (æ¯æ ¹æ‰£Â¥50)' : 'ä»“ä½å®‰å…¨'}</span>
                                        </div>
                                        <button onClick={handleSmokeIncrement} className="w-20 h-20 bg-gray-900 border-2 border-gray-700 rounded-full flex flex-col items-center justify-center active:scale-95 active:bg-red-900-50 active:border-red-500 transition-all shadow-lg hover:border-gray-500">
                                            <Icons.Cigarette className="text-gray-500 mb-1" size={24} />
                                            <span className="text-xxs font-bold text-gray-400">+1 æ ¹</span>
                                        </button>
                                    </div>
                                </div>

                                {/* ä»Šæ—¥äº¤å‰²å• - V2æ ·å¼å…¼å®¹ä¿®æ­£ */}
                                {todaySmokingLogs.length > 0 && (
                                    <div className="bg-gray-800-50 rounded-xl p-4 border border-gray-700">
                                        <h3 className="text-gray-400 text-xs font-bold uppercase tracking-wider mb-3 flex items-center">
                                            <Icons.Clock size={12} className="mr-1 text-orange-400" /> ä»Šæ—¥äº¤å‰²å• (Intraday)
                                        </h3>
                                        <div className="space-y-0 relative">
                                            {todaySmokingLogs.map((log, idx) => (
                                                <div key={log.id} className="flex relative pl-5 pb-4 timeline-item">
                                                    <div className="timeline-line"></div>
                                                    <div className="absolute left-0 top-1 w-4 h-4 rounded-full bg-gray-800 border-2 border-orange-500-50 flex items-center justify-center z-10">
                                                        <div className="w-1.5 h-1.5 rounded-full bg-orange-400"></div>
                                                    </div>
                                                    <div className="flex-1 ml-2">
                                                        <div className="flex justify-between items-center">
                                                            <span className="text-sm font-mono text-gray-200 font-bold">{log.time}</span>
                                                            <span className={`text-xs font-mono px-1.5 py-0.5 rounded ${log.intervalRaw < 60 && log.interval !== 'é¦–å•' ? 'bg-red-900-30 text-red-400' : 'bg-gray-700 text-gray-400'}`}>
                                                                {log.interval}
                                                            </span>
                                                        </div>
                                                        <div className="text-xs text-gray-400 mt-1 break-words">
                                                            è¯±å› : <span className="text-gray-300">{log.reason}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {Object.entries(groupedTasks).map(([category, tasks]) => (
                                    <div key={category} className="mb-2">
                                        <h3 className="text-gray-400 text-xs font-bold uppercase tracking-wider mb-2 flex items-center">
                                            <Icons.Zap size={12} className="mr-1 text-yellow-500" /> {category}
                                        </h3>
                                        <div className="space-y-2">
                                            {tasks.map(task => {
                                                const isDone = completedTasks[`${getDayKey()}_${task.id}`];
                                                if (task.isJournal) return null; 
                                                return (
                                                    <div key={task.id} onClick={() => handleTaskToggle(task)} className={`p-3 rounded-lg border flex justify-between items-center cursor-pointer transition-all ${isDone ? 'bg-green-900-20 border-green-800 opacity-50' : 'bg-gray-800 border-gray-700 hover:bg-gray-750'}`}>
                                                        <div className="flex items-center space-x-3">
                                                            <div className={`w-5 h-5 rounded border flex items-center justify-center ${isDone ? 'bg-green-500 border-green-500' : 'border-gray-500'}`}>
                                                                {isDone && <Icons.CheckCircle2 size={14} className="text-white" />}
                                                            </div>
                                                            <div className="flex flex-col">
                                                                <span className={isDone ? 'line-through text-gray-500' : 'text-gray-200 text-sm'}>{task.label}</span>
                                                            </div>
                                                        </div>
                                                        <span className={`text-sm font-mono ${isDone ? 'text-gray-500' : 'text-green-400'}`}>+Â¥{task.points}</span>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ))}

                                <div className="mt-6 border-t border-gray-800 pt-4">
                                    <h3 className="text-red-900-50 text-xs font-bold uppercase tracking-wider mb-2 flex items-center">
                                        <Icons.ShieldAlert size={12} className="mr-1" /> ä¸¥é‡è¿è§„ (ç†”æ–­)
                                    </h3>
                                    <div className="grid grid-cols-2 gap-3">
                                        <button onClick={() => handlePunishment('porn')} className="bg-gray-800 border border-gray-700 hover:border-red-500 p-2 rounded flex items-center justify-center space-x-2 transition-all">
                                            <Icons.Ban className="text-red-500" size={16} /> <span className="text-xs text-gray-400">è‰²æƒ… (-200)</span>
                                        </button>
                                        <button onClick={() => handlePunishment('contract')} className="bg-gray-800 border border-gray-700 hover:border-red-500 p-2 rounded flex items-center justify-center space-x-2 transition-all">
                                            <Icons.TrendingDown className="text-red-500" size={16} /> <span className="text-xs text-gray-400">åˆçº¦ (-500)</span>
                                        </button>
                                    </div>
                                </div>

                                <div className="pt-8 pb-8">
                                    <button onClick={nextDay} className="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-lg flex items-center justify-center space-x-2">
                                        <span>æ”¶ç›˜ç»“ç®— (è¿›å…¥ Day {Number(day) + 1})</span> <Icons.TrendingUp size={20} />
                                    </button>
                                </div>
                            </>
                        )}

                        {activeTab === 'journal' && (
                            <div className="space-y-4">
                                <h3 className="text-gray-400 text-xs font-bold uppercase tracking-wider flex items-center"><Icons.BookOpen size={12} className="mr-1" /> å†å²å¤ç›˜</h3>
                                {journals.length === 0 && <div className="text-gray-500 text-center text-xs py-4">æš‚æ— æ—¥å¿—è®°å½•ï¼Œå¿«å»é¦–é¡µå†™ä¸€æ¡å§ï¼</div>}
                                {journals.map((entry, idx) => (
                                    <div key={idx} className="bg-gray-800-50 border border-gray-700 p-3 rounded">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-blue-400 text-xs font-bold">Day {entry.day}</span>
                                            <span className="text-gray-500 text-xxs">{entry.date} {entry.timestamp}</span>
                                        </div>
                                        <p className="text-sm text-gray-300 whitespace-pre-wrap">{entry.content}</p>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'shop' && (
                            <div className="space-y-4">
                                <div className="bg-gray-800 p-4 rounded-lg border border-yellow-700-50">
                                    <div className="flex items-center space-x-2 mb-2 text-yellow-400"><Icons.ShoppingBag size={20} /><h2 className="font-bold">åˆ†çº¢å•†åŸ</h2></div>
                                    <p className="text-xs text-gray-400">ä¸¥ç¦é€æ”¯æœ¬é‡‘ã€‚</p>
                                </div>
                                <div className="grid grid-cols-1 gap-3">
                                    {REWARDS_DATA.map(item => (
                                        <button key={item.id} onClick={() => handleRedeem(item)} disabled={points < item.cost} className={`p-4 rounded-lg border flex justify-between items-center ${points >= item.cost ? 'bg-gray-800 border-gray-600 hover:bg-gray-700' : 'bg-gray-800-50 border-gray-800 opacity-50 cursor-not-allowed'}`}>
                                            <div className="flex items-center space-x-3"><div className="p-2 bg-gray-700 rounded-full text-blue-400">{item.icon}</div><span className="font-bold text-sm">{item.label}</span></div>
                                            <div className="text-yellow-400 font-mono font-bold text-sm">-Â¥{item.cost}</div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'logs' && (
                            <div className="space-y-2">
                                <h2 className="text-gray-400 text-xs font-bold uppercase tracking-wider mb-2">äº¤æ˜“æµæ°´</h2>
                                {logs.map(log => (
                                    <div key={log.id} className="flex justify-between items-center text-sm p-2 border-b border-gray-800">
                                        <div><div className="text-gray-300">{log.desc}</div><div className="text-xs text-gray-500">{log.time}</div></div>
                                        <div className={`font-mono font-bold ${log.amount > 0 ? 'text-green-500' : 'text-red-500'}`}>{log.amount > 0 ? '+' : ''}Â¥{Math.abs(log.amount)}</div>
                                    </div>
                                ))}
                                <div className="pt-8 flex justify-center">
                                    <button onClick={resetSystem} className="flex items-center space-x-1 text-xs text-red-900 hover:text-red-500"><Icons.RotateCcw size={12} /><span>é‡ç½®ç³»ç»Ÿ (ç ´äº§æ¸…ç®—)</span></button>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="bg-gray-800 border-t border-gray-700 p-2 grid grid-cols-4 gap-1">
                        <button onClick={() => setActiveTab('dashboard')} className={`flex flex-col items-center justify-center p-2 rounded ${activeTab === 'dashboard' ? 'text-green-400 bg-gray-700' : 'text-gray-400'}`}><Icons.Activity size={20} /><span className="text-xxs mt-1">æ“ç›˜å®¤</span></button>
                        <button onClick={() => setActiveTab('journal')} className={`flex flex-col items-center justify-center p-2 rounded ${activeTab === 'journal' ? 'text-blue-400 bg-gray-700' : 'text-gray-400'}`}><Icons.BookOpen size={20} /><span className="text-xxs mt-1">æ—¥å¿—</span></button>
                        <button onClick={() => setActiveTab('shop')} className={`flex flex-col items-center justify-center p-2 rounded ${activeTab === 'shop' ? 'text-yellow-400 bg-gray-700' : 'text-gray-400'}`}><Icons.ShoppingBag size={20} /><span className="text-xxs mt-1">å•†åŸ</span></button>
                        <button onClick={() => setActiveTab('logs')} className={`flex flex-col items-center justify-center p-2 rounded ${activeTab === 'logs' ? 'text-gray-200 bg-gray-700' : 'text-gray-400'}`}><Icons.TrendingUp size={20} /><span className="text-xxs mt-1">æµæ°´</span></button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CapitalRestructuringApp />);
    </script>
</body>
</html>